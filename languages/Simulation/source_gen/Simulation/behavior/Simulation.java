package Simulation.behavior;

/*Generated by MPS */

import java.util.List;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import DateTime.behavior.DateTime__BehaviorDescriptor;
import Facts.behavior.Fact__BehaviorDescriptor;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import Position.behavior.StateType__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import Position.behavior.State__BehaviorDescriptor;
import java.awt.Color;

public class Simulation {
  public static boolean actionTypeExists(List<SNode> states, SNode action) {
    boolean valid;
    // Action exists as a type in the begin states 
    valid = ListSequence.fromList(actionsTypesFromStateTypes(states)).contains(SNodeOperations.cast(SLinkOperations.getTarget(action, MetaAdapterFactory.getReferenceLink(0x2aacdfbf487f43acL, 0xa43119468403f2c5L, 0xe475eafb2f47ca7L, 0xe475eafb2f47ca8L, "facttype")), MetaAdapterFactory.getConcept(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x313fc3cd0ceebeb5L, "Position.structure.ActionType")));
    return valid;
  }
  public static boolean actionTypeHasValidStartDate(List<SNode> states, SNode action) {
    boolean valid;
    valid = DateTime__BehaviorDescriptor.getDateTime_id5riiL_BUVyA.invoke(SLinkOperations.getTarget(Fact__BehaviorDescriptor.getValueOfValidFrom_id36gwYufl4Bp.invoke(getState(states, action)), MetaAdapterFactory.getContainmentLink(0x2aacdfbf487f43acL, 0xa43119468403f2c5L, 0x432375ab9804ef36L, 0x432375ab9804ef37L, "value"))).isBefore(DateTime__BehaviorDescriptor.getDateTime_id5riiL_BUVyA.invoke(SLinkOperations.getTarget(Fact__BehaviorDescriptor.getValueOfKnownAt_id36gwYufl4AW.invoke(action), MetaAdapterFactory.getContainmentLink(0x2aacdfbf487f43acL, 0xa43119468403f2c5L, 0x432375ab9804ef36L, 0x432375ab9804ef37L, "value"))));
    return valid;
  }
  public static SNode getState(List<SNode> states, SNode action) {
    for (SNode state : ListSequence.fromList(states)) {
      {
        final SNode powerType = SLinkOperations.getTarget(state, MetaAdapterFactory.getReferenceLink(0x2aacdfbf487f43acL, 0xa43119468403f2c5L, 0xe475eafb2f47ca7L, 0xe475eafb2f47ca8L, "facttype"));
        if (SNodeOperations.isInstanceOf(powerType, MetaAdapterFactory.getConcept(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x313fc3cd0cdf2c74L, "Position.structure.PowerType"))) {
          if (SNodeOperations.cast(SLinkOperations.getTarget(action, MetaAdapterFactory.getReferenceLink(0x2aacdfbf487f43acL, 0xa43119468403f2c5L, 0xe475eafb2f47ca7L, 0xe475eafb2f47ca8L, "facttype")), MetaAdapterFactory.getConcept(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x313fc3cd0ceebeb5L, "Position.structure.ActionType")) == SNodeOperations.cast(SLinkOperations.getTarget(powerType, MetaAdapterFactory.getContainmentLink(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x313fc3cd0cdf2c74L, 0x313fc3cd0ce0d0e0L, "action")), MetaAdapterFactory.getConcept(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x313fc3cd0ceebeb5L, "Position.structure.ActionType"))) {
            return state;
          }
        }
      }
      {
        final SNode obligationType = SLinkOperations.getTarget(state, MetaAdapterFactory.getReferenceLink(0x2aacdfbf487f43acL, 0xa43119468403f2c5L, 0xe475eafb2f47ca7L, 0xe475eafb2f47ca8L, "facttype"));
        if (SNodeOperations.isInstanceOf(obligationType, MetaAdapterFactory.getConcept(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x2ccf4d5a1f3e01d6L, "Position.structure.ObligationType"))) {
          if (SNodeOperations.cast(SLinkOperations.getTarget(action, MetaAdapterFactory.getReferenceLink(0x2aacdfbf487f43acL, 0xa43119468403f2c5L, 0xe475eafb2f47ca7L, 0xe475eafb2f47ca8L, "facttype")), MetaAdapterFactory.getConcept(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x313fc3cd0ceebeb5L, "Position.structure.ActionType")) == SNodeOperations.cast(SLinkOperations.getTarget(obligationType, MetaAdapterFactory.getContainmentLink(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x2ccf4d5a1f3e01d6L, 0x2ccf4d5a1f403befL, "action")), MetaAdapterFactory.getConcept(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x313fc3cd0ceebeb5L, "Position.structure.ActionType"))) {
            return state;
          }
        }
      }
      {
        final SNode immunityType = SLinkOperations.getTarget(state, MetaAdapterFactory.getReferenceLink(0x2aacdfbf487f43acL, 0xa43119468403f2c5L, 0xe475eafb2f47ca7L, 0xe475eafb2f47ca8L, "facttype"));
        if (SNodeOperations.isInstanceOf(immunityType, MetaAdapterFactory.getConcept(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x2ccf4d5a1f4ef965L, "Position.structure.ImmunityType"))) {
          if (SNodeOperations.cast(SLinkOperations.getTarget(action, MetaAdapterFactory.getReferenceLink(0x2aacdfbf487f43acL, 0xa43119468403f2c5L, 0xe475eafb2f47ca7L, 0xe475eafb2f47ca8L, "facttype")), MetaAdapterFactory.getConcept(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x313fc3cd0ceebeb5L, "Position.structure.ActionType")) == SNodeOperations.cast(SLinkOperations.getTarget(immunityType, MetaAdapterFactory.getContainmentLink(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x2ccf4d5a1f4ef965L, 0x2ccf4d5a1f4f278bL, "action")), MetaAdapterFactory.getConcept(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x313fc3cd0ceebeb5L, "Position.structure.ActionType"))) {
            return state;
          }
        }
      }
    }
    return null;
  }

  public static List<SNode> actionsTypesFromStateTypes(List<SNode> states) {
    List<SNode> ActionTypes = new ArrayList<SNode>();
    for (SNode state : ListSequence.fromList(states)) {
      {
        final SNode powerType = SLinkOperations.getTarget(state, MetaAdapterFactory.getReferenceLink(0x2aacdfbf487f43acL, 0xa43119468403f2c5L, 0xe475eafb2f47ca7L, 0xe475eafb2f47ca8L, "facttype"));
        if (SNodeOperations.isInstanceOf(powerType, MetaAdapterFactory.getConcept(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x313fc3cd0cdf2c74L, "Position.structure.PowerType"))) {
          ListSequence.fromList(ActionTypes).addElement(SNodeOperations.cast(SLinkOperations.getTarget(powerType, MetaAdapterFactory.getContainmentLink(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x313fc3cd0cdf2c74L, 0x313fc3cd0ce0d0e0L, "action")), MetaAdapterFactory.getConcept(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x313fc3cd0ceebeb5L, "Position.structure.ActionType")));
        }
      }
      {
        final SNode obligationType = SLinkOperations.getTarget(state, MetaAdapterFactory.getReferenceLink(0x2aacdfbf487f43acL, 0xa43119468403f2c5L, 0xe475eafb2f47ca7L, 0xe475eafb2f47ca8L, "facttype"));
        if (SNodeOperations.isInstanceOf(obligationType, MetaAdapterFactory.getConcept(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x2ccf4d5a1f3e01d6L, "Position.structure.ObligationType"))) {
          ListSequence.fromList(ActionTypes).addElement(SNodeOperations.cast(SLinkOperations.getTarget(obligationType, MetaAdapterFactory.getContainmentLink(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x2ccf4d5a1f3e01d6L, 0x2ccf4d5a1f403befL, "action")), MetaAdapterFactory.getConcept(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x313fc3cd0ceebeb5L, "Position.structure.ActionType")));
        }
      }
      {
        final SNode immunityType = SLinkOperations.getTarget(state, MetaAdapterFactory.getReferenceLink(0x2aacdfbf487f43acL, 0xa43119468403f2c5L, 0xe475eafb2f47ca7L, 0xe475eafb2f47ca8L, "facttype"));
        if (SNodeOperations.isInstanceOf(immunityType, MetaAdapterFactory.getConcept(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x2ccf4d5a1f4ef965L, "Position.structure.ImmunityType"))) {
          ListSequence.fromList(ActionTypes).addElement(SNodeOperations.cast(SLinkOperations.getTarget(immunityType, MetaAdapterFactory.getContainmentLink(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x2ccf4d5a1f4ef965L, 0x2ccf4d5a1f4f278bL, "action")), MetaAdapterFactory.getConcept(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x313fc3cd0ceebeb5L, "Position.structure.ActionType")));
        }
      }
    }
    return ActionTypes;
  }

  public static List<SNode> ExecuteAction(List<SNode> states, SNode action) {
    if (actionTypeExists(states, action)) {
      for (SNode newStateType : Sequence.fromIterable(SLinkOperations.collect(ListSequence.fromList(SLinkOperations.getChildren(SNodeOperations.cast(SLinkOperations.getTarget(action, MetaAdapterFactory.getReferenceLink(0x2aacdfbf487f43acL, 0xa43119468403f2c5L, 0xe475eafb2f47ca7L, 0xe475eafb2f47ca8L, "facttype")), MetaAdapterFactory.getConcept(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x313fc3cd0ceebeb5L, "Position.structure.ActionType")), MetaAdapterFactory.getContainmentLink(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x337a9c0102b9418cL, 0x78836771e8cfbff3L, "transitions"))).where(new IWhereFilter<SNode>() {
        public boolean accept(SNode it) {
          return SPropertyOperations.hasValue(it, MetaAdapterFactory.getProperty(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x78836771e8cfbf8dL, 0x78836771e8cfbfdeL, "type"), "C", "C");
        }
      }), MetaAdapterFactory.getReferenceLink(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x78836771e8cfbf8dL, 0x78836771e8cfbf94L, "state")))) {
        SNode newState = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x7e8caa0ea161570dL, "Position.structure.State"));
        SLinkOperations.setTarget(newState, MetaAdapterFactory.getReferenceLink(0x2aacdfbf487f43acL, 0xa43119468403f2c5L, 0xe475eafb2f47ca7L, 0xe475eafb2f47ca8L, "facttype"), newStateType);
        Fact__BehaviorDescriptor.setValueOfValidFrom_id6hrFqLu1H2b.invoke(newState, SNodeOperations.copyNode(Fact__BehaviorDescriptor.getValueOfKnownAt_id36gwYufl4AW.invoke(action)));
        Fact__BehaviorDescriptor.setValueOfValidToToMax_id16mnka59X7s.invoke(newState);
        final SNode subjectTypeWithRight = StateType__BehaviorDescriptor.getSubjectWithRight_id7y3pR7CKsGF.invoke(newStateType);
        final SNode subjectTypeWithDuty = StateType__BehaviorDescriptor.getSubjectWithDuty_id7y3pR7CKiC7.invoke(newStateType);
        SNode subjectWithRight = ListSequence.fromList(SNodeOperations.getNodeDescendants(SNodeOperations.getContainingRoot(action), MetaAdapterFactory.getConcept(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x81c91b682e3b381L, "Position.structure.Subject"), false, new SAbstractConcept[]{})).where(new IWhereFilter<SNode>() {
          public boolean accept(SNode it) {
            return SLinkOperations.getTarget(it, MetaAdapterFactory.getReferenceLink(0x2aacdfbf487f43acL, 0xa43119468403f2c5L, 0xab4c0de8e6a127fL, 0xab4c0de8e6a1280L, "entitytype")) == subjectTypeWithRight;
          }
        }).first();
        SNode subjectWithDuty = ListSequence.fromList(SNodeOperations.getNodeDescendants(SNodeOperations.getContainingRoot(action), MetaAdapterFactory.getConcept(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x81c91b682e3b381L, "Position.structure.Subject"), false, new SAbstractConcept[]{})).where(new IWhereFilter<SNode>() {
          public boolean accept(SNode it) {
            return SLinkOperations.getTarget(it, MetaAdapterFactory.getReferenceLink(0x2aacdfbf487f43acL, 0xa43119468403f2c5L, 0xab4c0de8e6a127fL, 0xab4c0de8e6a1280L, "entitytype")) == subjectTypeWithDuty;
          }
        }).first();
        State__BehaviorDescriptor.setSubjectWithDuty_id16mnka5pfXG.invoke(newState, subjectWithDuty);
        State__BehaviorDescriptor.setSubjectWithRight_id16mnka5ptXK.invoke(newState, subjectWithRight);
        SPropertyOperations.set(newState, MetaAdapterFactory.getProperty(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x7e8caa0ea161570dL, 0x7e8caa0ea1982033L, "hidevariables"), "" + (true));
        ListSequence.fromList(states).addElement(newState);
      }
      for (final SNode stateTypeToBeEnded : Sequence.fromIterable(SLinkOperations.collect(ListSequence.fromList(SLinkOperations.getChildren(SNodeOperations.cast(SLinkOperations.getTarget(action, MetaAdapterFactory.getReferenceLink(0x2aacdfbf487f43acL, 0xa43119468403f2c5L, 0xe475eafb2f47ca7L, 0xe475eafb2f47ca8L, "facttype")), MetaAdapterFactory.getConcept(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x313fc3cd0ceebeb5L, "Position.structure.ActionType")), MetaAdapterFactory.getContainmentLink(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x337a9c0102b9418cL, 0x78836771e8cfbff3L, "transitions"))).where(new IWhereFilter<SNode>() {
        public boolean accept(SNode it) {
          return SPropertyOperations.hasValue(it, MetaAdapterFactory.getProperty(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x78836771e8cfbf8dL, 0x78836771e8cfbfdeL, "type"), "B", "C");
        }
      }), MetaAdapterFactory.getReferenceLink(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x78836771e8cfbf8dL, 0x78836771e8cfbf94L, "state")))) {
        SNode state = ListSequence.fromList(states).where(new IWhereFilter<SNode>() {
          public boolean accept(SNode it) {
            return SNodeOperations.cast(SLinkOperations.getTarget(it, MetaAdapterFactory.getReferenceLink(0x2aacdfbf487f43acL, 0xa43119468403f2c5L, 0xe475eafb2f47ca7L, 0xe475eafb2f47ca8L, "facttype")), MetaAdapterFactory.getConcept(0x1172cef30f894114L, 0xad0ef59cef2bbaa3L, 0x337a9c0102b43ef1L, "Position.structure.StateType")) == stateTypeToBeEnded;
          }
        }).first();
        Fact__BehaviorDescriptor.setValueOfValidTo_id16mnka5y9eK.invoke(state, SNodeOperations.copyNode(Fact__BehaviorDescriptor.getValueOfKnownAt_id36gwYufl4AW.invoke(action)));
      }
    }
    return states;
  }

  public static final Color RED = new Color(252, 225, 231);
  public static final Color GREEN = new Color(225, 252, 227);
  public static final Color YELLOW = new Color(247, 250, 177);

  public static Color GetTestresultColor(String testresult) {
    if (testresult.equals("failed")) {
      return RED;
    }
    if (testresult.equals("inconsistent")) {
      return YELLOW;
    }
    if (testresult.equals("success")) {
      return GREEN;
    }
    if (testresult.equals("nottested")) {
      return null;
    }
    return null;
  }
}
